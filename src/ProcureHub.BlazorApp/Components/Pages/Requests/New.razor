@page "/requests/new"
@attribute [Authorize(Roles = "Requester")]
@layout AuthenticatedLayout

@using ProcureHub.Application.Abstractions.Identity
@using ProcureHub.Application.Features.Categories
@using ProcureHub.Application.Features.Departments
@using ProcureHub.Application.Features.PurchaseRequests

@inject IRequestHandler<QueryCategories.Request, QueryCategories.Response[]> QueryCategoriesHandler
@inject IRequestHandler<QueryDepartments.Request, QueryDepartments.Response[]> QueryDepartmentsHandler
@inject IRequestHandler<CreatePurchaseRequest.Command, Result<Guid>> CreateHandler
@inject IRequestHandler<SubmitPurchaseRequest.Command, Result> SubmitHandler
@inject ICurrentUserProvider CurrentUserProvider
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject ILogger<New> Logger

<PageTitle>New Request</PageTitle>

<RadzenStack Gap="1rem">
    <PageHeader Title="New Purchase Request" Subtitle="Create a new purchase request for goods or services" />

    @if (_errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
            @_errorMessage
        </RadzenAlert>
    }

    <RadzenRow Gap="1rem">
        @* Left column: Request Details form *@
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard>
                <PurchaseRequestForm 
                    @bind-Value="_model" 
                    EditContext="_editContext"
                    Categories="_categories" 
                    Departments="_departments" />
            </RadzenCard>
        </RadzenColumn>

        @* Right column: Actions *@
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 600;">Actions</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                            Save as draft or submit for approval
                        </RadzenText>
                    </RadzenStack>

                    <RadzenButton Text="Submit for Approval" Icon="send"
                                  Click="@(() => SubmitForm(submitAfterCreate: true))"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Style="width: 100%;"
                                  Disabled="@_isSaving" />

                    <RadzenButton Text="Save as Draft" Icon="save"
                                  Click="@(() => SubmitForm(submitAfterCreate: false))"
                                  ButtonStyle="ButtonStyle.Light"
                                  Style="width: 100%;"
                                  Disabled="@_isSaving" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private PurchaseRequestFormModel _model = new();
    private EditContext? _editContext;
    private QueryCategories.Response[] _categories = [];
    private QueryDepartments.Response[] _departments = [];
    private bool _isSaving;
    private bool _submitAfterCreate;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);
        _categories = await QueryCategoriesHandler.HandleAsync(new QueryCategories.Request(), CancellationToken.None);
        _departments = await QueryDepartmentsHandler.HandleAsync(new QueryDepartments.Request(), CancellationToken.None);
    }

    private async Task SubmitForm(bool submitAfterCreate)
    {
        _submitAfterCreate = submitAfterCreate;

        if (_editContext is null)
        {
            return;
        }

        // Trigger EditForm validation which invokes FluentValidator
        var isValid = _editContext.Validate();
        if (isValid)
        {
            await CreateRequest();
        }
    }

    private async Task CreateRequest()
    {
        _errorMessage = null;
        _isSaving = true;

        try
        {
            var currentUser = await CurrentUserProvider.GetCurrentUserAsync();
            if (currentUser.UserId is null)
            {
                Logger.LogError("UserId is null for authenticated user on create purchase request page. This indicates an authentication configuration issue.");
                _errorMessage = "Authentication error. Please sign out and sign in again.";
                return;
            }

            var command = new CreatePurchaseRequest.Command(
                _model.Title,
                _model.Description,
                _model.EstimatedAmount,
                _model.BusinessJustification,
                _model.CategoryId!.Value,
                _model.DepartmentId!.Value,
                currentUser.UserId.Value.ToString()
            );

            var createResult = await CreateHandler.HandleAsync(command, CancellationToken.None);
            if (createResult.IsFailure)
            {
                _errorMessage = createResult.Error.Message;
                return;
            }

            if (_submitAfterCreate)
            {
                var submitResult = await SubmitHandler.HandleAsync(
                    new SubmitPurchaseRequest.Command(createResult.Value), CancellationToken.None);

                if (submitResult.IsFailure)
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Saved as Draft",
                        $"Request created but could not be submitted: {submitResult.Error.Message}");

                    // Navigate away immediately after successful creation to prevent duplicate requests
                    // if user retries after a submit failure
                    Navigation.NavigateTo("/requests");
                    return;
                }

                NotificationService.Notify(NotificationSeverity.Success, "Submitted", "Purchase request submitted for approval");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Purchase request saved as draft");
            }

            Navigation.NavigateTo("/requests");
        }
        finally
        {
            _isSaving = false;
        }
    }
}
