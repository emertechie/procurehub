@using ProcureHub.Application.Features.Departments
@using ProcureHub.Application.Features.Users

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IRequestDispatcher RequestDispatcher

<RadzenStack Gap="1rem">
    @if (_errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
            @_errorMessage
        </RadzenAlert>
    }

    @if (_isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else
    {
        <RadzenFormField Text="Department">
            <RadzenDropDown TValue="Guid?"
                            @bind-Value="@_selectedDepartmentId"
                            Data="@_departments"
                            TextProperty="Name"
                            ValueProperty="Id"
                            AllowClear="true"
                            Placeholder="Select department..."
                            Style="width: 100%;" />
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Save" Click="@OnSubmit" ButtonStyle="ButtonStyle.Primary" Disabled="@_isSaving" />
            <RadzenButton Text="Cancel" Click="@Cancel" ButtonStyle="ButtonStyle.Light" Disabled="@_isSaving" />
        </RadzenStack>
    }
</RadzenStack>

@code {
    [Parameter] public Guid UserId { get; set; }
    
    private QueryDepartments.Response[] _departments = [];
    private Guid? _selectedDepartmentId;
    private bool _isLoading = true;
    private bool _isSaving;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        try
        {
            // Load all departments
            _departments = await RequestDispatcher.SendAsync(new QueryDepartments.Request(), CancellationToken.None);

            // Load user's current department
            var user = await RequestDispatcher.SendAsync(new GetUserById.Request(UserId.ToString()), CancellationToken.None);
            if (user == null)
            {
                _errorMessage = "User not found";
                return;
            }

            _selectedDepartmentId = user.Department?.Id;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnSubmit()
    {
        _errorMessage = null;
        _isSaving = true;

        try
        {
            var command = new AssignUserToDepartment.Command(UserId.ToString(), _selectedDepartmentId);
            var result = await RequestDispatcher.SendAsync(command, CancellationToken.None);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Department updated");
                DialogService.Close(true);
            }
            else
            {
                _errorMessage = result.Error.Message;
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }
}
